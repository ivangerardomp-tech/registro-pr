<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Registro PR</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f172a" />

  <style>
    body {
      background: #0f172a;
      color: #f8fafc;
      font-family: system-ui, sans-serif;
      padding: 16px;
      max-width: 480px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 1rem;
    }

    .card {
      background: #1e2537;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 1rem;
    }

    button {
      width: 100%;
      background: #38bdf8;
      color: #0f172a;
      font-weight: 600;
      padding: 14px 16px;
      border-radius: 10px;
      border: 0;
      font-size: 1rem;
    }

    button:active {
      scale: .98;
    }

    .row {
      display: flex;
      flex-direction: column;
      gap: .5rem;
      font-size: .9rem;
      line-height: 1.3rem;
      word-break: break-word;
    }

    img#preview {
      width: 100%;
      max-height: 240px;
      object-fit: contain;
      background: #000;
      border-radius: 8px;
      border: 1px solid #334155;
    }

    .label {
      color: #94a3b8;
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .05em;
    }

    .value {
      color: #f8fafc;
      font-size: .9rem;
      font-family: ui-monospace, SFMono-Regular, monospace;
    }

    .small-note {
      font-size: .7rem;
      color: #64748b;
    }

    .hidden {
      display: none;
    }

    input.value {
      background:#0f172a;
      border:1px solid #334155;
      border-radius:8px;
      padding:8px;
      color:#f8fafc;
    }
  </style>
</head>
<body>
  <header>
    <h2>Registro PR</h2>
    <div class="small-note">Beta PWA offline</div>
  </header>

  <!-- GPS -->
  <section class="card">
    <div class="row">
      <div class="label">Ubicación actual</div>
      <div class="value" id="coords">lat: ---, lon: ---</div>
      <button id="btnGPS">Obtener GPS</button>
      <div class="small-note">
        Activa ubicación de alta precisión en el teléfono antes de capturar.
      </div>
    </div>
  </section>

  <!-- Foto -->
  <section class="card">
    <div class="row">
      <div class="label">Foto</div>

      <img id="preview" class="hidden" alt="preview" />

      <input
        id="inputCam"
        type="file"
        accept="image/*"
        capture="environment"
        class="hidden"
      />

      <button id="btnFoto">Tomar foto</button>

      <div class="small-note">
        Usa la cámara trasera. La imagen NO se sube a ningún servidor todavía.
      </div>
    </div>
  </section>

  <!-- PR + descarga -->
  <section class="card">
    <div class="row">
      <div class="label">PR calculado</div>
      <input
        id="prField"
        class="value"
        placeholder="PR_000+000"
      />

      <button id="btnDescargar" disabled>Guardar en el teléfono</button>

      <div class="small-note">
        Genera un archivo .jpg con este nombre y lo descarga en tu celular.
      </div>
    </div>
  </section>

  <!-- Historial local (cola offline futura) -->
  <section class="card">
    <div class="row">
      <div class="label">Historial local (demo)</div>
      <div class="small-note">
        Aquí luego guardaremos (offline) lat/lon/PR/foto para subirlos más tarde al servidor.
      </div>
      <pre id="historial" class="value" style="white-space:pre-wrap; font-size:.8rem; line-height:1.2rem;">[ Vacío ]</pre>
    </div>
  </section>

  <!-- Logs -->
  <section class="card">
    <div class="row">
      <div class="label">Log</div>
      <div id="log" class="value" style="white-space:pre-line; font-size:.8rem; line-height:1.2rem;">
        Listo.
      </div>
    </div>
  </section>

  <script>
    // Elementos DOM
    const btnGPS        = document.getElementById("btnGPS");
    const coordsEl      = document.getElementById("coords");
    const btnFoto       = document.getElementById("btnFoto");
    const inputCam      = document.getElementById("inputCam");
    const previewImg    = document.getElementById("preview");
    const prField       = document.getElementById("prField");
    const btnDescargar  = document.getElementById("btnDescargar");
    const logEl         = document.getElementById("log");
    const historialEl   = document.getElementById("historial");

    let lastPhotoBlob = null;
    let lastCaptureData = []; // en memoria. Paso siguiente sería guardarlo en IndexedDB.

    function log(msg) {
      console.log(msg);
      logEl.textContent = msg;
    }

    // 1. Obtener GPS
    btnGPS.addEventListener("click", () => {
      if (!("geolocation" in navigator)) {
        log("Geolocalización no soportada.");
        return;
      }

      log("Obteniendo coordenadas...");

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude.toFixed(6);
          const lon = pos.coords.longitude.toFixed(6);
          coordsEl.textContent = "lat: " + lat + ", lon: " + lon;

          // TODO: aquí metes tu cálculo real de PR según lat/lon contra tu eje vial
          const prEstimado = "PR_" +
            Math.floor(Math.random()*200) +
            "+" +
            String(Math.floor(Math.random()*1000)).padStart(3,"0");

          prField.value = prEstimado;

          log("Coordenadas OK y PR estimado generado.");
        },
        (err) => {
          log("Error GPS: " + err.message);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    });

    // 2. Tomar foto
    btnFoto.addEventListener("click", () => {
      inputCam.click();
    });

    inputCam.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) {
        log("No se seleccionó foto.");
        return;
      }

      lastPhotoBlob = file;

      const url = URL.createObjectURL(file);
      previewImg.src = url;
      previewImg.classList.remove("hidden");

      btnDescargar.disabled = false;
      log("Foto lista (" + (file.size/1024).toFixed(1) + " KB).");
    });

    // 3. Descargar con nombre PR
    btnDescargar.addEventListener("click", () => {
      if (!lastPhotoBlob) {
        log("No hay foto para descargar.");
        return;
      }

      let nombrePR = prField.value.trim();
      if (!nombrePR) {
        nombrePR = "PR_sin_nombre";
      }
      if (!nombrePR.toLowerCase().endsWith(".jpg")) {
        nombrePR += ".jpg";
      }

      const a = document.createElement("a");
      a.href = URL.createObjectURL(lastPhotoBlob);
      a.download = nombrePR;
      a.click();
      URL.revokeObjectURL(a.href);

      log("Descargando "" + nombrePR + "". Revisa Descargas / Archivos.");

      // Guardar registro en la "cola" local de capturas (demo)
      const nowIso = new Date().toISOString();
      const coordsText = coordsEl.textContent;
      lastCaptureData.push({
        timestamp: nowIso,
        coords: coordsText,
        pr: prField.value,
        filename: nombrePR,
        sizeKB: (lastPhotoBlob.size/1024).toFixed(1)
      });

      historialEl.textContent = JSON.stringify(lastCaptureData, null, 2);
    });

    // Registrar service worker para PWA offline
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js").then(() => {
        console.log("Service Worker registrado");
      }).catch(err => {
        console.warn("SW fallo:", err);
      });
    }
  </script>
</body>
</html>
