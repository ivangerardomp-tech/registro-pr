<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Registro PR (v14)</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root { --bg:#0f172a; --card:#1e2537; --b:#334155; --text:#f8fafc; --muted:#94a3b8; --brand:#38bdf8; }
    * { box-sizing:border-box }
    body { background: var(--bg); color: var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; padding:16px; max-width: 820px; margin:0 auto; }
    header { text-align:center; margin-bottom: 12px; }
    .card { background: var(--card); border:1px solid var(--b); border-radius:12px; padding:14px; margin-bottom:12px; }
    .row { display:flex; flex-direction:column; gap:8px }
    .row-h { display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .label { color:var(--muted); font-size:.75rem; text-transform:uppercase; letter-spacing:.05em }
    .value { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; white-space: pre-line }
    .hint { color:#94a3b8; font-size:.8rem }
    .ok { color:#22c55e } .bad { color:#ef4444 } .pill { padding:4px 8px; border:1px solid var(--b); border-radius:999px; font-size:.8rem; background:#0b1324 }
    select, button, input { background: var(--bg); color: var(--text); border:1px solid var(--b); border-radius:8px; padding:10px; }
    button { background: var(--brand); color:#0b1324; font-weight:700; border:0; cursor:pointer }
  </style>
</head>
<body>
  <header>
    <h2>Registro PR v14</h2>
    <div class="hint">La lista de TRAMOS se llena desde <b>PRs.csv</b>. Los KML deben llamarse <b>TRAMO.kml</b>.</div>
  </header>

  <section class="card">
    <div class="row">
      <div class="label">1) Cargar PRs.csv del repositorio</div>
      <div class="row-h">
        <button id="btnLoadRepoPRS">Cargar PRs del repo</button>
        <span id="prsBadge" class="pill" style="display:none"></span>
      </div>
      <div id="prsStatus" class="value">Pendiente.</div>
      <div id="prsDebug" class="value" style="font-size:.8rem;color:#9ca3af">—</div>
      <div class="hint">Comprueba que <code>PRs.csv</code> está en la misma carpeta que este <code>index.html</code>.</div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">2) Seleccionar TRAMO</div>
      <div class="row-h">
        <select id="tramoSelect"><option value="">— Selecciona —</option></select>
        <button id="btnLoadKML">Cargar KML</button>
        <span id="tramoBadge" class="pill" style="display:none"></span>
      </div>
      <div id="kmlStatus" class="value">Sin ruta.</div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">3) Coordenadas manuales</div>
      <div class="row-h"><input id="latIn" placeholder="lat"><input id="lonIn" placeholder="lon"><button id="btnCalc">Calcular</button></div>
      <div id="result" class="value">—</div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">4) Cámara</div>
      <div id="videoWrap" style="display:none;">
        <div id="topBadge">Cámara activa</div>
        <video id="video" autoplay playsinline muted></video>
        <div id="overlay">lat: —, lon: — | PR: —</div>
      </div>
      <div class="row-h">
        <button id="btnOpenCam">Abrir cámara</button>
        <button id="btnSnap" disabled>Capturar foto</button>
      </div>
      <div id="iosFallback" class="hidden">
        <div class="warn">iOS PWA: usa el selector del sistema</div>
        <input id="fileInput" type="file" accept="image/*" capture="environment" />
      </div>
      <img id="previewImg" style="display:none;max-width:100%" alt="captura">
    </div>
  </section>

<script>
const R=6371000,KML_BASE='./';
function toRad(d){return d*Math.PI/180}
function hav(aLat,aLon,bLat,bLon){const dLat=toRad(bLat-aLat),dLon=toRad(bLon-aLon);const x=Math.sin(dLat/2)**2+Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLon/2)**2;return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))}
function parseCSVsmart(text){const sep=text.indexOf('\t')>-1?'\t':(text.indexOf(';')>-1&&text.indexOf(',')>-1?',':(text.indexOf(';')>-1?';':','));const delimiter=sep==='\t'?'\t':sep;const rows=[];let i=0,cur='',inQ=false,row=[];const push=()=>{if(row.length)rows.push(row);row=[]};while(i<text.length){const ch=text[i];if(inQ){if(ch=='"'){if(text[i+1]=='"'){cur+='"';i+=2;continue}inQ=false;i++;continue}cur+=ch;i++;continue}else{if(ch=='"'){inQ=true;i++;continue}if((delimiter==='\t'&&ch==='\t')||c...
function normalizeHeaders(header){const map=new Map();header.forEach((h,idx)=>{const key=String(h).toUpperCase().replace(/\s+/g,'');map.set(key,idx)});return map}
function num(x){if(x==null)return NaN;let s=String(x).trim().replace(',','.');if(s==='')return NaN;const v=Number(s);return Number.isFinite(v)?v:NaN}
function status(id,html){document.getElementById(id).innerHTML=html}
function debug(msg){document.getElementById('prsDebug').textContent=msg}
let prsIndex=new Map(),locator=null,tramoActual=null;
async function loadPRs(){try{const r=await fetch('./PRs.csv',{cache:'no-store'});if(!r.ok){status('prsStatus',`<span class="bad">No se pudo leer PRs.csv (HTTP ${r.status})</span>`);debug('Ruta esperada: ./PRs.csv');return}const text=await r.text();const{header,rows}=parseCSVsmart(text);if(!header.length){status('prsStatus','<span class="bad">PRs.csv sin encabezado</span>');return}const H=normalizeHeaders(header);const idxTramo=H.get('TRAMO')??H.get('IDTRAMO')??H.get('CODIGOTRAMO');const idxPR=H.get('PR')...
document.getElementById('btnLoadRepoPRS').addEventListener('click',loadPRs);loadPRs();
async function fetchKML(url){const r=await fetch(url,{cache:'no-store'});if(!r.ok)throw new Error('HTTP '+r.status);const text=await r.text();const xml=new DOMParser().parseFromString(text,'application/xml');const coords=[...xml.getElementsByTagName('coordinates')];let lonlat=[];for(const n of coords){const t=(n.textContent||'').trim();if(!t)continue;const toks=t.replace(/\s+/g,' ').split(' ').filter(Boolean);for(const tk of toks){const p=tk.split(',');if(p.length>=2)lonlat.push([parseFloat(p[0]),parseF...
document.getElementById('btnLoadKML').addEventListener('click',async()=>{const tramo=document.getElementById('tramoSelect').value.trim().toUpperCase();if(!tramo){status('kmlStatus','<span class="bad">Selecciona un TRAMO.</span>');return}try{const pts=await fetchKML(KML_BASE+encodeURIComponent(tramo)+'.kml');locator=buildLocator(pts);tramoActual=tramo;status('kmlStatus',`<span class="ok">Ruta cargada.</span> Vértices: ${pts.length}`);document.getElementById('tramoBadge').textContent='TRAMO: '+tramo;document.getElementById('tramoBadge').style.display='inline-block'}catch(e){status('kmlStatus','<span class="bad">Error KML: '+e.message+'</span>')}});
document.getElementById('btnCalc').addEventListener('click',()=>{if(!locator){status('result','Carga primero el KML.');return}const lat=Number(document.getElementById('latIn').value),lon=Number(document.getElementById('lonIn').value);if(!isFinite(lat)||!isFinite(lon)){status('result','Lat/lon inválidos.');return}const r=distFromOrigin(lat,lon,locator);let prTxt='—';if(tramoActual&&prsIndex.has(tramoActual)){const it=buscarPR(tramoActual,r.distance_from_origin_m);if(it){prTxt=String(it.basePR).replace(/\s+/g,'')+'+'+String(Math.max(0,it.metros)).padStart(3,'0')}else prTxt='Sin PR para esa distancia'}else prTxt='Falta PRs.csv o TRAMO.';status('result',`dist_origen: ${r.distance_from_origin_m.toFixed(2)} m\nPR: ${prTxt}`)});
if('serviceWorker'in navigator){navigator.serviceWorker.register('./service-worker.js').catch(()=>{})}
</script>
</body>
</html>
