<!doctype html><html lang="es"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<link rel="manifest" href="manifest.json"><title>PR Live</title>
<style>
:root{--bg:#0f172a;--card:#1e2537;--b:#334155;--text:#f8fafc;--muted:#94a3b8;--brand:#38bdf8}
*{box-sizing:border-box}body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;padding:16px;max-width:760px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:14px;margin-bottom:12px}.row{display:flex;flex-direction:column;gap:8px}
.row-h{display:flex;gap:8px;flex-wrap:wrap;align-items:center}.label{color:var(--muted);font-size:.75rem;text-transform:uppercase;letter-spacing:.05em}
.value{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}.hint{color:#64748b;font-size:.8rem}
select,button,input{background:var(--bg);color:var(--text);border:1px solid var(--b);border-radius:8px;padding:10px}button{background:var(--brand);color:#0b1324;font-weight:700;border:0;cursor:pointer}
.ok{color:#22c55e}.bad{color:#ef4444}.pill{padding:4px 8px;border:1px solid var(--b);border-radius:999px;font-size:.8rem;background:#0b1324}
#videoWrap{position:relative;width:100%;border-radius:12px;overflow:hidden;border:1px solid var(--b);background:#000;display:none}video{width:100%;height:auto}
#overlay{position:absolute;left:0;right:0;bottom:0;background:rgba(0,0,0,.55);color:#fff;padding:8px 10px;font-family:ui-monospace,Menlo,monospace;font-size:.85rem;line-height:1.2rem}
</style>
<body>
<h2>Registro PR</h2><div class="hint">Elige TRAMO y la app descarga <b>TRAMO.kml</b> + lee <b>PRs.csv</b> del repo.</div>
<section class="card"><div class="row"><div class="label">Tramo</div><div class="row-h"><select id="tramoSelect"><option value="">— Selecciona —</option></select><button id="btnLoadKML">Cargar KML</button><span id="tramoBadge" class="pill" style="display:none"></span></div><div id="kmlStatus" class="value">Sin ruta.</div></div></section>
<section class="card"><div class="row"><div class="label">PRs.csv</div><div class="row-h"><button id="btnLoadRepoPRS">Cargar PRs del repo</button><span id="prsBadge" class="pill" style="display:none"></span></div><div id="prsStatus" class="value">Intentando leer PRs.csv…</div></div></section>
<section class="card"><div class="row"><div class="label">GPS</div><div id="state" class="value">Cargando…</div><div id="coords" class="value">lat: —, lon: —</div></div></section>
<section class="card"><div class="row"><div class="label">Coordenadas manuales</div><div class="row-h"><input id="latIn" placeholder="lat"><input id="lonIn" placeholder="lon"><input id="offsetm" type="number" value="0" placeholder="offset m"><button id="btnCalc">Calcular</button></div></div></section>
<section class="card"><div class="row"><div class="label">Resultados</div><div id="result" class="value">—</div></div></section>
<section class="card"><div class="row"><div class="label">Cámara</div><div id="videoWrap"><video id="video" autoplay playsinline muted></video><div id="overlay">lat: —, lon: — | PR: —</div></div><div class="row-h"><button id="btnOpenCam">Abrir cámara</button><button id="btnSnap" disabled>Capturar foto</button></div><img id="previewImg" style="display:none;max-width:100%"></div></section>
<section class="card"><div class="row"><div class="label">Nombre PR</div><input id="prField" placeholder="PR_000+000"><div class="row-h"><button id="btnDownload" disabled>Descargar JPG</button><button id="btnShare" disabled>Compartir</button><button id="btnReset" onclick="location.reload()">Reiniciar</button></div></div></section>
<script>
const R=6371000,isHttps=location.protocol==='https:'||location.hostname==='localhost',KML_BASE='./';
function toRad(d){return d*Math.PI/180}function hav(lat1,lon1,lat2,lon2){const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}
function makeProj(lat0,lon0){const c=Math.cos(toRad(lat0));return{toXY:(lat,lon)=>[R*toRad(lon-lon0)*c,R*toRad(lat-lat0)],toLL:(x,y)=>[(y/R)*180/Math.PI+lat0,(x/(R*c))*180/Math.PI+lon0]}}
function cumGeo(ps){const n=ps.length,c=new Float64Array(n);let a=0;for(let i=0;i<n-1;i++){const[A,B]=[ps[i],ps[i+1]];a+=hav(A[0],A[1],B[0],B[1]);c[i+1]=a}return c}
function parseCSV(t){const sep=(t.includes(';')&&t.includes(','))?',':(t.includes(';')?';':',');const rows=[];let i=0,cur='',inQ=false,row=[];const push=()=>{if(row.length)rows.push(row);row=[]};while(i<t.length){const ch=t[i];if(inQ){if(ch=='"'){if(t[i+1]=='"'){cur+='"';i+=2;continue}inQ=false;i++;continue}cur+=ch;i++;continue}else{if(ch=='"'){inQ=true;i++;continue}if(ch==sep){row.push(cur);cur='';i++;continue}if(ch=='\n'){row.push(cur);cur='';push();i++;continue}if(ch=='\r'){i++;continue}cur+=ch;i++}}if(cur or row){row.push(cur);push()}const header=rows.shift().map(h=>h.replace(/^\ufeff/,'').trim());return rows.map(r=>{const o={};r.forEach((v,idx)=>o[header[idx]]=(v??'').trim());return o})}
function N(x){if(x==null)return NaN;let s=String(x).trim().replace(',','.');if(s==='')return NaN;const v=Number(s);return Number.isFinite(v)?v:NaN}
let locator=null,tramoActual=null,prsIndex=new Map(),lastCoords=null,watchId=null;
async function fetchKML(url){const r=await fetch(url,{cache:'no-store'});if(!r.ok)throw new Error('HTTP '+r.status);const text=await r.text();const xml=new DOMParser().parseFromString(text,'application/xml');const nodes=[...xml.getElementsByTagName('coordinates')];let lonlat=[];for(const n of nodes){const t=(n.textContent||'').trim();if(!t)continue;const toks=t.replace(/\s+/g,' ').split(' ').filter(Boolean);for(const tok of toks){const p=tok.split(',');if(p.length>=2)lonlat.push([parseFloat(p[0]),parseFloat(p[1])])}}const gx='http://www.google.com/kml/ext/2.2';const tags=xml.getElementsByTagNameNS(gx,'coord');for(const n of tags){const t=(n.textContent||'').trim();if(!t)continue;const p=t.split(/[\s,]+/).filter(Boolean);if(p.length>=2)lonlat.push([parseFloat(p[0]),parseFloat(p[1])])}if(!lonlat.length)throw new Error('KML sin LineString/Track');const merged=[];let l0=null,l1=null;for(const [lon,lat] of lonlat){if(l0===lon&&l1===lat)continue;merged.push([lat,lon]);l0=lon;l1=lat}if(merged.length<2)throw new Error('Ruta <2 vértices');return merged}
function buildLocator(ps){const [lat0,lon0]=ps[0];const proj=makeProj(lat0,lon0);const XY=ps.map(([lat,lon])=>proj.toXY(lat,lon));const cum=cumGeo(ps);return{proj,XY,LL:ps,cum}}
function distFromOrigin(lat,lon,loc){const{proj,XY,LL,cum}=loc;const[px,py]=proj.toXY(lat,lon);let bestK=0,bestD2=1/0;for(let k=0;k<XY.length;k++){const[x,y]=XY[k];const dx=x-px,dy=y-py;const d2=dx*dx+dy*dy;if(d2<bestD2){bestD2=d2;bestK=k}}const cands=[];if(bestK>0)cands.push([bestK-1,bestK]);if(bestK<XY.length-1)cands.push([bestK,bestK+1]);let best=null,b2=1/0;for(const[i0,i1]of cands){const A=XY[i0],B=XY[i1];const ABx=B[0]-A[0],ABy=B[1]-A[1];const AB2=ABx*ABx+ABy*ABy;if(AB2===0)continue;const APx=px-A[0],APy=py-A[1];const t=Math.max(0,Math.min(1,(APx*ABx+APy*ABy)/AB2));const qx=A[0]+t*ABx,qy=A[1]+t*ABy;const dx=qx-px,dy=qy-py;const d2=dx*dx+dy*dy;if(d2<b2){b2=d2;best={i0,t,projxy:[qx,qy]}}}const[projLat,projLon]=loc.proj.toLL(best.projxy[0],best.projxy[1]);const dRoute=hav(lat,lon,projLat,projLon);const i0=best.i0;const partial=hav(LL[i0][0],LL[i0][1],projLat,projLon);const d=cum[i0]+partial;return{distance_from_origin_m:d,distance_to_route_m:dRoute,nearest_latlon:[projLat,projLon],segment_index:i0}}
async function loadPRS(){try{const r=await fetch('./PRs.csv',{cache:'no-store'});if(!r.ok)throw new Error('HTTP '+r.status);const rows=parseCSV(await r.text());const by=new Map();for(const r of rows){const tramo=String((r['TRAMO']??r['tramo']??'')).trim().toUpperCase();const pr=String(r['PR']??r['pr']??'').trim();const dist=N(r['DISTANCIA']??r['distancia']);if(!tramo||!pr||!Number.isFinite(dist))continue;if(!by.has(tramo))by.set(tramo,[]);by.get(tramo).push({d:dist,pr})}prsIndex=new Map();const list=[];for(const[tramo,arr]of by){arr.sort((a,b)=>a.d-b.d);prsIndex.set(tramo,{dist:Float64Array.from(arr.map(o=>o.d)),pr:arr.map(o=>o.pr)});list.push(tramo)}list.sort((a,b)=>a.localeCompare(b,'es'));const sel=document.getElementById('tramoSelect');sel.innerHTML='<option value="">— Selecciona —</option>'+list.map(t=>`<option value="${t}">${t}</option>`).join('');document.getElementById('prsStatus').innerHTML='<span class="ok">PRs.csv cargado.</span> Tramos: '+prsIndex.size;document.getElementById('prsBadge').textContent='PRs OK';document.getElementById('prsBadge').style.display='inline-block'}catch(e){document.getElementById('prsStatus').innerHTML='<span class="bad">Error PRs: '+e.message+'</span>'}}
document.getElementById('btnLoadRepoPRS').addEventListener('click',loadPRS);loadPRS();
document.getElementById('btnLoadKML').addEventListener('click',async()=>{const tramo=document.getElementById('tramoSelect').value.trim().toUpperCase();if(!tramo){document.getElementById('kmlStatus').innerHTML='<span class="bad">Selecciona un TRAMO.</span>';return}try{const url=KML_BASE+encodeURIComponent(tramo)+'.kml';const pts=await fetchKML(url);locator=buildLocator(pts);tramoActual=tramo;document.getElementById('tramoBadge').textContent='TRAMO: '+tramo;document.getElementById('tramoBadge').style.display='inline-block';document.getElementById('kmlStatus').innerHTML='<span class="ok">Ruta cargada:</span> '+pts.length+' vértices.';if(lastCoords){render(distFromOrigin(lastCoords.latitude,lastCoords.longitude,locator))}}catch(e){document.getElementById('kmlStatus').innerHTML='<span class="bad">Error KML: '+e.message+'</span>'}});
document.getElementById('btnCalc').addEventListener('click',()=>{if(!locator){document.getElementById('result').textContent='Cargue primero un KML.';return}const lat=Number(document.getElementById('latIn').value),lon=Number(document.getElementById('lonIn').value);if(!isFinite(lat)||!isFinite(lon)){document.getElementById('result').textContent='Lat/lon inválidos.';return}render(distFromOrigin(lat,lon,locator))});
function buscarPR(tramo,objM){const reg=prsIndex.get(tramo);if(!reg)return null;const d=reg.dist,p=reg.pr;let lo=0,hi=d.length;while(lo<hi){const m=(lo+hi)>>1;if(d[m]<=objM)lo=m+1;else hi=m}const pos=lo-1;if(pos<0)return null;const base=d[pos],pr=p[pos],metros=objM-base;return{pr,metros:Math.round(metros)}}
function render(res){const el=document.getElementById('result'),ov=document.getElementById('overlay');if(!res){el.textContent='—';return}const dBase=res.distance_from_origin_m,offset=Number(document.getElementById('offsetm').value||0);const obj=dBase+(Number.isFinite(offset)?offset:0);let prTxt='—';if(tramoActual&&prsIndex.has(tramoActual)){const it=buscarPR(tramoActual,obj);if(it){const mm=String(Math.max(0,it.metros)).padStart(3,'0');prTxt=String(it.pr).replace(/\s+/g,'')+'+'+mm}else prTxt='Sin PR para esa distancia'}else prTxt='Falta PRs.csv o TRAMO.';const [nlat,nlon]=res.nearest_latlon;el.textContent=`dist_origen: ${dBase.toFixed(2)} m\npie: lat ${nlat.toFixed(6)}, lon ${nlon.toFixed(6)}\nPR: ${prTxt}`;if(lastCoords){ov.textContent=`lat: ${lastCoords.latitude.toFixed(6)}, lon: ${lastCoords.longitude.toFixed(6)} | PR: ${prTxt}`}}
function startGPS(){const s=document.getElementById('state');if(!(location.protocol==='https:'||location.hostname==='localhost')){s.textContent='GPS requiere HTTPS';return}if(!navigator.geolocation){s.textContent='Geolocalización no soportada';return}watchId=navigator.geolocation.watchPosition(p=>{lastCoords=p.coords;document.getElementById('coords').textContent=`lat: ${p.coords.latitude.toFixed(6)}, lon: ${p.coords.longitude.toFixed(6)}`;if(locator)render(distFromOrigin(p.coords.latitude,p.coords.longitude,locator));s.textContent='GPS activo'},err=>{s.textContent='Error GPS: '+err.message},{enableHighAccuracy:true,timeout:20000,maximumAge:0})}
startGPS();
if('serviceWorker' in navigator)navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
</script>
</body></html>
