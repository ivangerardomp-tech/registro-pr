<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Registro PR (KML + PRs del repo)</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root { --bg:#0f172a; --card:#1e2537; --b:#334155; --text:#f8fafc; --muted:#94a3b8; --brand:#38bdf8; }
    * { box-sizing:border-box }
    body { background: var(--bg); color: var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; padding:16px; max-width: 740px; margin:0 auto; }
    header { text-align:center; margin-bottom: 12px; }
    .card { background: var(--card); border:1px solid var(--b); border-radius:12px; padding:14px; margin-bottom:12px; }
    .row { display:flex; flex-direction:column; gap:8px }
    .row-h { display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .label { color:var(--muted); font-size:.75rem; text-transform:uppercase; letter-spacing:.05em }
    .value { font-family: ui-monospace, SFMono-Regular, Menlo, monospace }
    .hint { color:#64748b; font-size:.8rem }
    .warn { color:#fbbf24; font-size:.85rem }
    button { background: var(--brand); color:#0b1324; font-weight:700; padding:10px 12px; border-radius:10px; border:0; font-size:1rem }
    button:active { transform: scale(.98) }
    input.value, input[type=number] { width:100%; background: var(--bg); color: var(--text); border:1px solid var(--b); border-radius:8px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    #coords { white-space: pre-line }
    #videoWrap { position:relative; width:100%; border-radius:12px; overflow:hidden; border:1px solid var(--b); background:#000; display:none; }
    video { width:100%; height:auto; }
    #overlay { position:absolute; left:0; right:0; bottom:0; background: rgba(0,0,0,.55); color:#fff; padding:8px 10px; font-family: ui-monospace, Menlo, monospace; font-size:.85rem; line-height:1.2rem }
    #topBadge { position:absolute; top:8px; left:8px; background: rgba(15,23,42,.7); color:#fff; padding:6px 10px; border-radius:999px; font-size:.75rem; border:1px solid rgba(255,255,255,.15) }
    #previewImg { width:100%; max-height: 260px; object-fit:contain; display:none; border:1px solid var(--b); border-radius:8px }
    .hidden { display:none !important }
    .ok { color:#22c55e }
    .bad { color:#ef4444 }
    .pill { padding:4px 8px; border:1px solid var(--b); border-radius:999px; font-size:.8rem; background:#0b1324 }
  </style>
</head>
<body>
  <header>
    <h2>Registro PR</h2>
    <div class="hint">La app lee <b>PRs.csv</b> directamente del repositorio (misma carpeta que este archivo).</div>
  </header>

  <section class="card">
    <div class="row">
      <div class="label">1) Cargar KML de la ruta</div>
      <div class="row-h">
        <input id="kmlFile" type="file" accept=".kml" />
        <button id="btnLoadKML">Leer KML</button>
        <span id="tramoBadge" class="pill hidden"></span>
      </div>
      <div id="kmlStatus" class="value">Sin ruta.</div>
      <div class="hint">El tramo se infiere del nombre, p.ej.: <b>ruta_densa_10m_4505.kml ⇒ TRAMO=4505</b>.</div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">2) PRs.csv del repositorio</div>
      <div class="row-h">
        <button id="btnLoadRepoPRS">Cargar PRs del repo</button>
        <span id="prsBadge" class="pill hidden"></span>
      </div>
      <div id="prsStatus" class="value">Esperando cargar PRs.csv…</div>
      <div class="hint">Debe existir un archivo <b>PRs.csv</b> junto a este <code>index.html</code>.</div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">3) GPS en vivo</div>
      <div id="state" class="value">Cargando…</div>
      <div id="coords" class="value">lat: —, lon: —\nprecisión: — m\nvelocidad: — m/s</div>
      <button id="btnEnableGPS" class="hidden">Activar GPS</button>
      <div class="hint">HTTPS requerido. Si no aparece nada, toca “Activar GPS”.</div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">4) Entrar coordenadas manuales (opcional)</div>
      <div class="row-h">
        <input id="latIn" class="value" placeholder="lat" />
        <input id="lonIn" class="value" placeholder="lon" />
        <input id="offsetm" type="number" step="1" value="0" class="value" placeholder="offset PR (m)" />
        <button id="btnCalc">Calcular</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">Resultados</div>
      <div id="result" class="value">—</div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">Cámara</div>
      <div id="videoWrap">
        <div id="topBadge">Cámara activa</div>
        <video id="video" autoplay playsinline muted></video>
        <div id="overlay">lat: —, lon: — | precisión: — m | vel: — m/s | PR: —</div>
      </div>
      <div id="cameraCtl" class="row-h">
        <button id="btnOpenCam">Abrir cámara</button>
        <button id="btnSnap" disabled>Capturar foto</button>
      </div>
      <img id="previewImg" alt="captura" />
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">Nombre PR</div>
      <input id="prField" class="value" placeholder="PR_000+000" />
      <div class="row-h">
        <button id="btnDownload" disabled>Descargar JPG</button>
        <button id="btnShare" disabled>Compartir / Guardar en Fotos</button>
        <button id="btnReset">Reiniciar</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">Log</div>
      <div id="log" class="value" style="white-space:pre-line">Listo.</div>
    </div>
  </section>

<script>
const R = 6371000;
function toRad(d){ return d * Math.PI / 180; }
function haversine(lat1, lon1, lat2, lon2){
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function makeLocalProjector(lat0, lon0){
  const cos0 = Math.cos(toRad(lat0));
  return {
    toXY(lat, lon){ return [ R * toRad(lon - lon0) * cos0, R * toRad(lat - lat0) ]; },
    toLL(x, y){ return [ (y / R) * 180/Math.PI + lat0, (x / (R * cos0)) * 180/Math.PI + lon0 ]; }
  }
}
function cumulativeGeodesic(pointsLL){
  const n = pointsLL.length, cum = new Float64Array(n); let acc = 0;
  for (let i=0;i<n-1;i++){ const [aLat,aLon]=pointsLL[i], [bLat,bLon]=pointsLL[i+1]; acc += haversine(aLat,aLon,bLat,bLon); cum[i+1]=acc; }
  return cum;
}
function parseCSV(text){
  const sep = (text.indexOf(";") > -1 && text.indexOf(",") > -1) ? "," : (text.indexOf(";") > -1 ? ";" : ",");
  const rows = [];
  let i=0, cur="", inQ=false; let row=[];
  const pushCell = (cell) => { row.push(cell.replace(/^\ufeff/,"")); };
  const pushRow = () => { rows.push(row); row=[]; };
  while (i < text.length){
    const ch = text[i];
    if (inQ){
      if (ch === '"'){ if (text[i+1] === '"'){ cur+='"'; i+=2; continue; } inQ=false; i++; continue; }
      cur+=ch; i++; continue;
    } else {
      if (ch === '"'){ inQ=true; i++; continue; }
      if (ch === sep){ pushCell(cur); cur=""; i++; continue; }
      if (ch === '\n'){ pushCell(cur); cur=""; pushRow(); i++; continue; }
      if (ch === '\r'){ i++; continue; }
      cur += ch; i++;
    }
  }
  if (cur.length || row.length){ pushCell(cur); pushRow(); }
  const header = rows.shift().map(h => h.trim());
  return rows.map(r => { const o={}; r.forEach((v,idx)=>o[header[idx]]=(v??"").trim()); return o; });
}
function numOrNaN(x){
  if (x==null) return NaN;
  let s = String(x).trim().replace(",", ".");
  if (s==="") return NaN;
  const v = Number(s);
  return Number.isFinite(v) ? v : NaN;
}

// State
let locator = null;
let tramoActual = null;
let prsIndex = new Map();
let lastCoords = null, watchId = null;
const stateEl = document.getElementById('state');
const coordsEl = document.getElementById('coords');
const resultEl = document.getElementById('result');
const overlayEl = document.getElementById('overlay');
const prField = document.getElementById('prField');
const tramoBadge = document.getElementById('tramoBadge');
const prsBadge = document.getElementById('prsBadge');
const logEl = document.getElementById('log');

function log(msg){ console.log(msg); if (logEl) logEl.textContent = msg; }
function inferTramoFromKMLName(name){ const m = name.match(/ruta_densa_10m_([\w-]+)\.kml$/i); return m ? m[1].toUpperCase() : null; }

async function loadPRsFromRepo(){
  try{
    const r = await fetch('./PRs.csv', { cache: 'no-store' });
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const text = await r.text();
    const rows = parseCSV(text);
    const byTramo = new Map();
    for (const r of rows){
      const tramo = String((r["TRAMO"] ?? r["tramo"] ?? "")).trim().toUpperCase();
      const pr = String(r["PR"] ?? r["pr"] ?? "").trim();
      const dist = numOrNaN(r["DISTANCIA"] ?? r["distancia"]);
      if (!tramo || !pr || !Number.isFinite(dist)) continue;
      if (!byTramo.has(tramo)) byTramo.set(tramo, []);
      byTramo.get(tramo).push({ d: dist, pr });
    }
    prsIndex = new Map();
    for (const [tramo, arr] of byTramo){
      arr.sort((a,b) => a.d - b.d);
      prsIndex.set(tramo, { dist: Float64Array.from(arr.map(o=>o.d)), pr: arr.map(o=>o.pr) });
    }
    const nTramos = prsIndex.size;
    const totalPRS = [...prsIndex.values()].reduce((acc,v)=> acc + v.dist.length, 0);
    document.getElementById('prsStatus').innerHTML = `<span class="ok">PRs cargados del repo.</span> Tramos: ${nTramos}, filas: ${totalPRS}.`;
    prsBadge.textContent = 'PRs.csv cargado';
    prsBadge.classList.remove('hidden');
  }catch(e){
    document.getElementById('prsStatus').innerHTML = '<span class="bad">No se pudo leer PRs.csv del repo: '+ e.message +'</span>';
  }
}
document.getElementById('btnLoadRepoPRS').addEventListener('click', loadPRsFromRepo);
// Auto-carga al iniciar
loadPRsFromRepo();

// KML + locator
async function parseKML(file){
  const text = await file.text();
  const xml = new DOMParser().parseFromString(text, "application/xml");
  const coordsNodes = Array.from(xml.getElementsByTagName("coordinates"));
  let lonlat = [];
  for (const node of coordsNodes){
    const t = (node.textContent || "").trim();
    if (!t) continue;
    const tokens = t.replace(/\s+/g, " ").split(" ").filter(Boolean);
    for (const tok of tokens){
      const parts = tok.split(",");
      if (parts.length >= 2){
        lonlat.push([parseFloat(parts[0]), parseFloat(parts[1])]);
      }
    }
  }
  const gxNS = "http://www.google.com/kml/ext/2.2";
  const coordTags = xml.getElementsByTagNameNS(gxNS, "coord");
  for (const node of coordTags){
    const t = (node.textContent || "").trim();
    if (!t) continue;
    const parts = t.split(/[\s,]+/).filter(Boolean);
    if (parts.length >= 2){
      lonlat.push([parseFloat(parts[0]), parseFloat(parts[1])]);
    }
  }
  if (!lonlat.length) throw new Error("No se encontró geometría de línea en el KML.");
  const merged = []; let last0=null, last1=null;
  for (const [lon,lat] of lonlat){
    if (last0===lon && last1===lat) continue; merged.push([lat,lon]); last0=lon; last1=lat;
  }
  if (merged.length < 2) throw new Error("La línea resultante tiene menos de 2 vértices.");
  return merged;
}
function buildLocator(densePoints){
  const [lat0, lon0] = densePoints[0];
  const proj = makeLocalProjector(lat0, lon0);
  const XY = densePoints.map(([lat,lon]) => proj.toXY(lat,lon));
  const cum = cumulativeGeodesic(densePoints);
  return { proj, XY, LL: densePoints, cum };
}
function distanceFromOrigin(lat, lon, loc){
  const { proj, XY, LL, cum } = loc;
  const [px, py] = proj.toXY(lat, lon);
  let bestK=0, bestD2=Infinity;
  for (let k=0;k<XY.length;k++){ const [x,y]=XY[k]; const dx=x-px, dy=y-py; const d2=dx*dx+dy*dy; if (d2<bestD2){bestD2=d2; bestK=k;} }
  const cands=[]; if (bestK>0) cands.push([bestK-1,bestK]); if (bestK<XY.length-1) cands.push([bestK,bestK+1]);
  let best=null, bestSegD2=Infinity;
  for (const [i0,i1] of cands){
    const A=XY[i0], B=XY[i1]; const ABx=B[0]-A[0], ABy=B[1]-A[1]; const AB2=ABx*ABx+ABy*ABy; if (AB2===0) continue;
    const APx=px-A[0], APy=py-A[1]; const t=Math.max(0,Math.min(1,(APx*ABx+APy*ABy)/AB2));
    const projx=A[0]+t*ABx, projy=A[1]+t*ABy; const dx=projx-px, dy=projy-py; const d2=dx*dx+dy*dy;
    if (d2<bestSegD2){ bestSegD2=d2; best={i0,i1,t,projxy:[projx,projy]}; }
  }
  const [projLat, projLon] = loc.proj.toLL(best.projxy[0], best.projxy[1]);
  const dToRoute = haversine(lat, lon, projLat, projLon);
  const i0=best.i0; const partial = haversine(LL[i0][0], LL[i0][1], projLat, projLon);
  const distFromOrigin = cum[i0] + partial;
  return { distance_from_origin_m: distFromOrigin, distance_to_route_m: dToRoute, nearest_latlon:[projLat,projLon], segment_index:i0 };
}

// Manual
document.getElementById('btnLoadKML').addEventListener('click', async () => {
  try{
    const f = document.getElementById('kmlFile').files?.[0];
    if (!f){ document.getElementById('kmlStatus').innerHTML = '<span class="bad">Seleccione un KML.</span>'; return; }
    const pts = await parseKML(f);
    locator = buildLocator(pts);
    document.getElementById('kmlStatus').innerHTML = `<span class="ok">Ruta cargada:</span> ${pts.length} vértices.`;
    tramoActual = inferTramoFromKMLName(f.name);
    const tb = document.getElementById('tramoBadge');
    if (tramoActual){ tb.textContent = 'TRAMO: ' + tramoActual; tb.classList.remove('hidden'); } else { tb.classList.add('hidden'); }
  }catch(e){
    document.getElementById('kmlStatus').innerHTML = '<span class="bad">Error: '+ e.message +'</span>';
  }
});
document.getElementById('btnCalc').addEventListener('click', () => {
  if (!locator){ document.getElementById('result').textContent = 'Cargue primero un KML.'; return; }
  const lat = Number(document.getElementById('latIn').value), lon = Number(document.getElementById('lonIn').value);
  if (!isFinite(lat) || !isFinite(lon)){ document.getElementById('result').textContent = 'Lat/lon inválidos.'; return; }
  const res = distanceFromOrigin(lat, lon, locator);
  renderResult(res);
});

// GPS
function startWatchPosition(){
  if (!navigator.geolocation) { stateEl.textContent = 'Geolocalización no soportada.'; return; }
  try {
    if (watchId !== null) navigator.geolocation.clearWatch(watchId);
    watchId = navigator.geolocation.watchPosition((pos) => {
      const { latitude, longitude, accuracy, speed } = pos.coords;
      lastCoords = { latitude, longitude, accuracy, speed };
      const lat = latitude?.toFixed(6);
      const lon = longitude?.toFixed(6);
      const acc = (accuracy ?? NaN).toFixed(1);
      const vel = (speed ?? 0);
      const velFmt = (isFinite(vel) ? vel.toFixed(2) : '—');
      coordsEl.textContent = `lat: ${lat}, lon: ${lon}\nprecisión: ${acc} m\nvelocidad: ${velFmt} m/s`;
      if (locator){
        const res = distanceFromOrigin(latitude, longitude, locator);
        renderResult(res);
      }
      stateEl.textContent = 'GPS activo (watchPosition).';
    }, (err) => {
      stateEl.textContent = 'Error GPS: ' + err.message;
      document.getElementById('btnEnableGPS').classList.remove('hidden');
    }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
  } catch(e){
    stateEl.textContent = 'Excepción GPS: ' + e.message;
    document.getElementById('btnEnableGPS').classList.remove('hidden');
  }
}
startWatchPosition();
document.getElementById('btnEnableGPS').addEventListener('click', () => {
  navigator.geolocation.getCurrentPosition(
    () => { document.getElementById('btnEnableGPS').classList.add('hidden'); startWatchPosition(); },
    (err) => { stateEl.textContent = 'GPS denegado: ' + err.message; },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );
});

// Cámara
async function openCameraStream(){
  if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)){ return; }
  try {
    const constraints = { video: { facingMode: { ideal: 'environment' } }, audio: false };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    videoEl.srcObject = stream;
    document.getElementById('videoWrap').style.display = 'block';
    btnSnap.disabled = false;
    stateEl.textContent = 'Cámara en vivo activa.';
  } catch (e) {
    stateEl.textContent = 'No se pudo abrir la cámara: ' + e.message;
  }
}
btnOpenCam.addEventListener('click', openCameraStream);

btnSnap.addEventListener('click', () => {
  if (!videoEl.videoWidth) { log('Video no listo'); return; }
  const canvas = document.createElement('canvas');
  canvas.width = videoEl.videoWidth;
  canvas.height = videoEl.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(videoEl, 0, 0);
  ctx.fillStyle = 'rgba(0,0,0,0.6)';
  const barH = Math.round(canvas.height * 0.07);
  ctx.fillRect(0, canvas.height - barH, canvas.width, barH);
  ctx.fillStyle = '#fff';
  const fontSize = Math.max(18, Math.round(canvas.width * 0.03));
  ctx.font = `${fontSize}px ui-monospace, Menlo, monospace`;
  ctx.fillText(document.getElementById('overlay').textContent, Math.round(canvas.width*0.02), canvas.height - Math.round(barH*0.35));
  canvas.toBlob((blob) => {
    const url = URL.createObjectURL(blob);
    previewImg.src = url;
    previewImg.style.display = 'block';
    btnDownload.disabled = false;
    // share support
    const name = (prField.value || 'PR_sin_nombre').trim() + '.jpg';
    const fileObj = new File([blob], name, { type:'image/jpeg' });
    btnShare.disabled = !(navigator.canShare && navigator.canShare({ files: [fileObj] }));
    btnShare.onclick = async () => {
      try { await navigator.share({ files: [fileObj], title: name, text: 'Captura PR' }); } catch {}
    };
    btnDownload.onclick = () => {
      const a = document.createElement('a');
      a.href = url;
      a.download = name;
      a.click();
      URL.revokeObjectURL(url);
    };
  }, 'image/jpeg', 0.92);
});

btnReset.addEventListener('click', () => {
  previewImg.style.display = 'none'; previewImg.src = '';
  btnDownload.disabled = true; btnShare.disabled = true;
});

// SW
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./service-worker.js').catch(()=>{}); }
</script>
</body>
</html>
