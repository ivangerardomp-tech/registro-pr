<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>PR desde KML</title>
<link rel="manifest" href="manifest.json" />
<style>
  body {
    background:#0f172a;
    color:#f8fafc;
    font-family:system-ui,Segoe UI,Roboto,Arial;
    margin:0;
    padding:0;
  }
  h1{text-align:center;padding:16px 0;}
  section.card{
    max-width:720px;
    margin:16px auto;
    padding:16px;
    background:#0b1220;
    border:1px solid #334155;
    border-radius:12px;
  }
  .label{margin-bottom:8px;font-weight:bold;}
  input[type=file],input[type=text]{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #334155;
    background:#1e293b;
    color:#f8fafc;
  }
  button.btn{
    cursor:pointer;
    padding:10px 16px;
    border-radius:8px;
    border:1px solid #334155;
    background:#1e293b;
    color:#f8fafc;
    margin-top:8px;
  }
  #pr-badge{
    position:fixed;
    left:12px;
    bottom:12px;
    z-index:9999;
    background:#0f172a;
    color:#e2e8f0;
    padding:8px 12px;
    border:1px solid #334155;
    border-radius:10px;
    box-shadow:0 6px 20px rgba(0,0,0,.35);
  }
  .preview{max-width:100%;display:block;margin:10px 0;border-radius:10px;border:1px solid #334155}
</style>
</head>
<body>
<h1>PR desde KML + Foto con PR</h1>

<!-- === CARGA DEL KML === -->
<section class="card">
  <div class="label">Ruta (KML densificado)</div>
  <input id="kmlInput" type="file" accept=".kml" />
  <div id="kmlInfo" style="font-size:13px;margin-top:6px;opacity:.85">Sin ruta cargada.</div>
</section>

<!-- === PR calculado === -->
<section class="card">
  <div class="label">PR calculado</div>
  <input id="prField" type="text" readonly />
  <button id="btnTestCoords" class="btn" type="button">Probar con coordenadas actuales</button>
</section>

<!-- === FOTO CON PR === -->
<section class="card">
  <div class="label">Insertar PR en imagen</div>
  <input id="photoInput" type="file" accept="image/*" capture="environment" />
  <img id="previewImg" class="preview" alt="Vista previa" style="display:none"/>
  <button id="btnSavePR" class="btn" type="button" disabled>Guardar JPG con PR</button>
  <a id="downloadLink" style="margin-left:10px"></a>
</section>

<div id="pr-badge">PR: —</div>

<script>
// ====== RUTA / KML → PR ======
const kmlInput = document.getElementById('kmlInput');
const kmlInfo  = document.getElementById('kmlInfo');
const prField  = document.getElementById('prField');
const badge    = document.getElementById('pr-badge');
const btnTest  = document.getElementById('btnTestCoords');

let routePts=[], cumDist=[], routeReady=false, lastCoords=null;

function haversine(lat1, lon1, lat2, lon2){
  const R=6371008.8, toRad=Math.PI/180;
  const dLat=(lat2-lat1)*toRad, dLon=(lon2-lon1)*toRad;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*toRad)*Math.cos(lat2*toRad)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function toXY(lat,lon,lat0){const R=6371008.8,toRad=Math.PI/180;return{x:R*(lon*toRad)*Math.cos(lat0*toRad),y:R*(lat*toRad)}}
function pointToSegmentProgress(lat,lon,A,B,lat0){
  const P=toXY(lat,lon,lat0),a=toXY(A.lat,A.lon,lat0),b=toXY(B.lat,B.lon,lat0);
  const vx=b.x-a.x,vy=b.y-a.y,wx=P.x-a.x,wy=P.y-a.y;const L2=vx*vx+vy*vy||1e-9;
  let t=(vx*wx+vy*wy)/L2;t=Math.max(0,Math.min(1,t));
  const px=a.x+t*vx,py=a.y+t*vy;const d=Math.hypot(P.x-px,P.y-py);return{dist:d,t};
}
function parseKML(txt){
  const xml=new DOMParser().parseFromString(txt,'application/xml');
  const coords=Array.from(xml.getElementsByTagName('coordinates'));
  const pts=[];
  for(const node of coords){
    const raw=node.textContent.trim().split(/\\s+/);
    for(const triple of raw){
      const [lonS,latS]=triple.split(','),lon=parseFloat(lonS),lat=parseFloat(latS);
      if(isFinite(lat)&&isFinite(lon)){
        const last=pts[pts.length-1];
        if(!last||last.lat!==lat||last.lon!==lon)pts.push({lat,lon});
      }
    }
  }
  if(pts.length<2)throw new Error("No se encontró LineString válida en el KML");
  return pts;
}
function buildCumDist(pts){
  const acc=[0];
  for(let i=1;i<pts.length;i++)acc[i]=acc[i-1]+haversine(pts[i-1].lat,pts[i-1].lon,pts[i].lat,pts[i].lon);
  return acc;
}
function computePRfromLatLon(lat,lon){
  if(!routeReady)return null;
  const lat0=routePts[Math.floor(routePts.length/2)].lat;
  let best={dist:Infinity,i:0,t:0};
  for(let i=0;i<routePts.length-1;i++){
    const res=pointToSegmentProgress(lat,lon,routePts[i],routePts[i+1],lat0);
    if(res.dist<best.dist)best={dist:res.dist,i,t:res.t};
  }
  const segLen=haversine(routePts[best.i].lat,routePts[best.i].lon,routePts[best.i+1].lat,routePts[best.i+1].lon);
  const d=cumDist[best.i]+best.t*segLen;
  const km=Math.floor(d/1000),m=Math.round(d-km*1000);
  const prTxt=`PR_${String(km).padStart(3,'0')}+${String(m).padStart(3,'0')}`;
  return{d,km,m,prTxt};
}
function updateBadge(pr){badge.textContent='PR: '+pr;}

kmlInput.addEventListener('change',async e=>{
  const f=e.target.files[0];if(!f)return;
  try{
    const txt=await f.text();
    routePts=parseKML(txt);cumDist=buildCumDist(routePts);routeReady=true;
    const tot=(cumDist[cumDist.length-1]/1000).toFixed(3);
    kmlInfo.textContent=`Ruta cargada: ${routePts.length} pts, ${tot} km.`;
    if(lastCoords){const r=computePRfromLatLon(lastCoords.latitude,lastCoords.longitude);
      if(r){prField.value=r.prTxt;updateBadge(r.prTxt);}
    }
  }catch(err){kmlInfo.textContent='Error: '+err.message;}
});

btnTest.addEventListener('click',()=>{
  if(!routeReady){alert('Carga el KML primero');return;}
  if(!lastCoords){alert('No hay coordenadas GPS');return;}
  const r=computePRfromLatLon(lastCoords.latitude,lastCoords.longitude);
  if(r){prField.value=r.prTxt;updateBadge(r.prTxt);}
});

// GPS
if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
    lastCoords={latitude:pos.coords.latitude,longitude:pos.coords.longitude};
    if(routeReady){
      const r=computePRfromLatLon(lastCoords.latitude,lastCoords.longitude);
      if(r){prField.value=r.prTxt;updateBadge(r.prTxt);}
    }
  });
}

// === Inserta PR en imagen ===
const photoInput=document.getElementById('photoInput');
const preview=document.getElementById('previewImg');
const btnSave=document.getElementById('btnSavePR');
const dl=document.getElementById('downloadLink');
let imgBitmap=null,imgName='foto';
function readAsDataURL(f){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(f);});}
photoInput.addEventListener('change',async e=>{
  const f=e.target.files[0];if(!f)return;
  imgName=f.name.replace(/\\.[^.]+$/,'');
  const url=await readAsDataURL(f);
  preview.src=url;preview.style.display='block';
  imgBitmap=await createImageBitmap(f);
  btnSave.disabled=false;dl.textContent='';dl.removeAttribute('href');
});
function drawPR(bitmap,pr){
  const w=bitmap.width,h=bitmap.height,bandH=Math.round(Math.max(48,h*0.06));
  const pad=Math.round(bandH*0.25),fontSize=Math.round(bandH*0.5);
  const c=document.createElement('canvas');c.width=w;c.height=h+bandH;
  const ctx=c.getContext('2d');
  ctx.drawImage(bitmap,0,0,w,h);
  ctx.fillStyle='#0b1220';ctx.fillRect(0,h,w,bandH);
  const now=new Date(),extra=now.toISOString().slice(0,19).replace('T',' ');
  ctx.font=`bold ${fontSize}px system-ui`;ctx.fillStyle='#d1e9ff';ctx.textBaseline='middle';
  ctx.fillText(`PR: ${pr}`,pad,h+bandH/2);
  const exw=ctx.measureText(extra).width;
  ctx.fillText(extra,w-pad-exw,h+bandH/2);
  return c;
}
btnSave.addEventListener('click',async()=>{
  if(!imgBitmap)return alert('Selecciona una imagen');
  const pr=(prField.value||'—');
  const c=drawPR(imgBitmap,pr);
  const blob=await new Promise(res=>c.toBlob(res,'image/jpeg',0.9));
  const url=URL.createObjectURL(blob);
  dl.href=url;dl.download=`${imgName}_conPR.jpg`;dl.textContent='Descargar imagen';
});
</script>
</body>
</html>
