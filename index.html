<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Registro PR (KML + PRs del repo)</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="mobile-web-app-capable" content="yes"> <!-- Fixed iOS meta -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root { --bg:#0f172a; --card:#1e2537; --b:#334155; --text:#f8fafc; --muted:#94a3b8; --brand:#38bdf8; }
    * { box-sizing:border-box }
    body { background: var(--bg); color: var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; padding:16px; max-width: 740px; margin:0 auto; }
    header { text-align:center; margin-bottom: 12px; }
    .card { background: var(--card); border:1px solid var(--b); border-radius:12px; padding:14px; margin-bottom:12px; }
    .row { display:flex; flex-direction:column; gap:8px }
    .row-h { display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .label { color:var(--muted); font-size:.75rem; text-transform:uppercase; letter-spacing:.05em }
    .value { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; white-space: pre-line }
    .hint { color:#64748b; font-size:.8rem }
    .warn { color:#fbbf24; font-size:.85rem }
    button { background: var(--brand); color:#0b1324; font-weight:700; padding:10px 12px; border-radius:10px; border:0; font-size:1rem; cursor:pointer }
    button:active { transform: scale(.98) }
    input.value, input[type=number] { width:100%; background: var(--bg); color: var(--text); border:1px solid var(--b); border-radius:8px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    #coords { white-space: pre-line }
    #videoWrap { position:relative; width:100%; border-radius:12px; overflow:hidden; border:1px solid var(--b); background:#000; display:none; }
    video { width:100%; height:auto; }
    #overlay { position:absolute; left:0; right:0; bottom:0; background: rgba(0,0,0,.55); color:#fff; padding:8px 10px; font-family: ui-monospace, Menlo; font-size:.85rem; line-height:1.2rem }
    #topBadge { position:absolute; top:8px; left:8px; background: rgba(15,23,42,.7); color:#fff; padding:6px 10px; border-radius:999px; font-size:.75rem; border:1px solid rgba(255,255,255,.15) }
    #previewImg { width:100%; max-height: 260px; object-fit:contain; display:none; border:1px solid var(--b); border-radius:8px }
    .hidden { display:none !important }
    .ok { color:#22c55e }
    .bad { color:#ef4444 }
    .pill { padding:4px 8px; border:1px solid var(--b); border-radius:999px; font-size:.8rem; background:#0b1324 }
  </style>
</head>
<body>
  <header>
    <h2>Registro PR</h2>
    <div class="hint">Lee <b>PRs.csv</b> del repositorio y descarga el <b>TRAMO.kml</b> por selección. Si no calcula, refresca fuerte (Ctrl+F5) o borra datos del sitio para actualizar la caché.</div>
  </header>

  <section class="card">
    <div class="row">
      <div class="label">1) Seleccionar TRAMO (KML del repo)</div>
      <div class="row-h">
        <select id="tramoSelect"><option value="">— Selecciona —</option></select>
        <button id="btnLoadKML">Cargar KML</button>
        <span id="tramoBadge" class="pill hidden"></span>
      </div>
      <div id="kmlStatus" class="value">Sin ruta.</div>
      <div class="hint">Los archivos KML deben llamarse exactamente como el TRAMO, p.ej.: <b>4505.kml</b>, <b>45HLC.kml</b>. Si los tienes en subcarpeta, ajusta <code>KML_BASE</code>.</div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">2) PRs.csv del repositorio</div>
      <div class="row-h">
        <button id="btnLoadRepoPRS">Cargar PRs del repo</button>
        <span id="prsBadge" class="pill hidden"></span>
      </div>
      <div id="prsStatus" class="value">Intentando leer PRs.csv…</div>
      <div id="prsDebug" class="value" style="font-size:.8rem; color:#9ca3af">—</div>
      <div class="hint">Debe existir <b>PRs.csv</b> junto a este <code>index.html</code>.</div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">3) GPS en vivo</div>
      <div id="state" class="value">Cargando…</div>
      <div id="coords" class="value">lat: —, lon: —
precisión: — m
velocidad: — m/s</div>
      <button id="btnEnableGPS" class="hidden">Activar GPS</button>
      <div class="hint">Requiere HTTPS y permisos de ubicación.</div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">4) Entrar coordenadas manuales (opcional)</div>
      <div class="row-h">
        <input id="latIn" class="value" placeholder="lat" />
        <input id="lonIn" class="value" placeholder="lon" />
        <input id="offsetm" type="number" step="1" value="0" class="value" placeholder="offset PR (m)" />
        <button id="btnCalc">Calcular</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">Resultados</div>
      <div id="result" class="value">—</div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">Cámara</div>
      <div id="videoWrap">
        <div id="topBadge">Cámara activa</div>
        <video id="video" autoplay playsinline muted></video>
        <div id="overlay">lat: —, lon: — | precisión: — m | vel: — m/s | PR: —</div>
      </div>
      <div class="row-h">
        <button id="btnOpenCam">Abrir cámara</button>
        <button id="btnSnap" disabled>Capturar foto</button>
      </div>
      <div id="iosFallback" class="hidden">
        <div class="warn">iOS PWA: usa el selector del sistema</div>
        <input id="fileInput" type="file" accept="image/*" capture="environment" />
      </div>
      <img id="previewImg" alt="captura" />
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">Nombre PR</div>
      <input id="prField" class="value" placeholder="PR_000+000" />
      <div class="row-h">
        <button id="btnDownload" disabled>Descargar JPG</button>
        <button id="btnShare" disabled>Compartir / Guardar en Fotos</button>
        <button id="btnReset">Reiniciar</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="label">Log</div>
      <div id="log" class="value" style="white-space:pre-line">Listo.</div>
    </div>
  </section>

<script>
const R = 6371000;
// Código de GPS, KML, PRs.csv sigue igual...
// Todo lo relacionado con la cámara y selección de TRAMO también
</script>
</body>
</html>
